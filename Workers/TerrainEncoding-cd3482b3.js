define(["exports","./Transforms-1142ce48","./Cartesian2-08065eec","./Check-be2d5acb","./when-ad3237a0","./AttributeCompression-9fbb8447","./ComponentDatatype-a867ddaa","./Math-5ca9b250"],(function(e,t,i,a,r,o,n,s){"use strict";function c(e,t){this._ellipsoid=e,this._cameraPosition=new i.Cartesian3,this._cameraPositionInScaledSpace=new i.Cartesian3,this._distanceToLimbInScaledSpaceSquared=0,r.defined(t)&&(this.cameraPosition=t)}Object.defineProperties(c.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){var t=this._ellipsoid.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),a=i.Cartesian3.magnitudeSquared(t)-1;i.Cartesian3.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=t,this._distanceToLimbInScaledSpaceSquared=a}}});var d=new i.Cartesian3;c.prototype.isPointVisible=function(e){return C(this._ellipsoid.transformPositionToScaledSpace(e,d),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},c.prototype.isScaledSpacePointVisible=function(e){return C(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};var u=new i.Cartesian3;c.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){var i,a=this._ellipsoid;return t=r.defined(t)&&t<0&&a.minimumRadius>-t?((i=u).x=this._cameraPosition.x/(a.radii.x+t),i.y=this._cameraPosition.y/(a.radii.y+t),i.z=this._cameraPosition.z/(a.radii.z+t),i.x*i.x+i.y*i.y+i.z*i.z-1):(i=this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared),C(e,i,t)},c.prototype.computeHorizonCullingPoint=function(e,t,i){return p(this._ellipsoid,e,t,i)};var m=i.Ellipsoid.clone(i.Ellipsoid.UNIT_SPHERE);c.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,a){return p(f(this._ellipsoid,i,m),e,t,a)},c.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,a,r){return S(this._ellipsoid,e,t,i,a,r)},c.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,a,r,o){return S(f(this._ellipsoid,r,m),e,t,i,a,o)};var l=[];c.prototype.computeHorizonCullingPointFromRectangle=function(e,a,r){var o=i.Rectangle.subsample(e,a,0,l);if(e=t.BoundingSphere.fromPoints(o),!(i.Cartesian3.magnitude(e.center)<.1*a.minimumRadius))return this.computeHorizonCullingPoint(e.center,o,r)};var h=new i.Cartesian3;function f(e,t,a){return r.defined(t)&&t<0&&e.minimumRadius>-t&&(t=i.Cartesian3.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,h),e=i.Ellipsoid.fromCartesian3(t,a)),e}function p(e,t,a,o){r.defined(o)||(o=new i.Cartesian3);for(var n=T(e,t),s=0,c=0,d=a.length;c<d;++c){var u=N(e,a[c],n);if(u<0)return;s=Math.max(s,u)}return b(n,s,o)}var x=new i.Cartesian3;function S(e,t,a,o,n,s){r.defined(s)||(s=new i.Cartesian3),o=r.defaultValue(o,3),n=r.defaultValue(n,i.Cartesian3.ZERO);for(var c=T(e,t),d=0,u=0,m=a.length;u<m;u+=o){x.x=a[u]+n.x,x.y=a[u+1]+n.y,x.z=a[u+2]+n.z;var l=N(e,x,c);if(l<0)return;d=Math.max(d,l)}return b(c,d,s)}function C(e,t,a){return e=i.Cartesian3.subtract(e,t,d),t=-i.Cartesian3.dot(e,t),!(a<0?0<t:a<t&&t*t/i.Cartesian3.magnitudeSquared(e)>a)}var g=new i.Cartesian3,y=new i.Cartesian3;function N(e,t,a){var r=e.transformPositionToScaledSpace(t,g);return e=i.Cartesian3.magnitudeSquared(r),t=Math.sqrt(e),r=i.Cartesian3.divideByScalar(r,t,y),e=Math.max(1,e),t=1/(t=Math.max(1,t)),1/(i.Cartesian3.dot(r,a)*t-i.Cartesian3.magnitude(i.Cartesian3.cross(r,a,r))*(Math.sqrt(e-1)*t))}function b(e,t,a){if(!(t<=0||t===1/0||t!=t))return i.Cartesian3.multiplyByScalar(e,t,a)}var M=new i.Cartesian3;function T(e,t){return i.Cartesian3.equals(t,i.Cartesian3.ZERO)?t:(e.transformPositionToScaledSpace(t,M),i.Cartesian3.normalize(M,M))}var P={getHeight:function(e,t,i){return(e-i)*t+i}},v=new i.Cartesian3;P.getPosition=function(e,t,a,r,o){return e=t.cartesianToCartographic(e,v),r=P.getHeight(e.height,a,r),i.Cartesian3.fromRadians(e.longitude,e.latitude,r,t,o)};var z=Object.freeze({NONE:0,BITS12:1}),_=new i.Cartesian3,E=new i.Cartesian3,H=new i.Cartesian2,w=new t.Matrix4,A=new t.Matrix4,I=Math.pow(2,12);function q(e,a,o,n,s,c,d,u,m,l){var h,f,p,x=z.NONE;r.defined(a)&&r.defined(o)&&r.defined(n)&&r.defined(s)&&(p=a.minimum,h=a.maximum,a=i.Cartesian3.subtract(h,p,E),f=n-o,x=Math.max(i.Cartesian3.maximumComponent(a),f)<I-1?z.BITS12:z.NONE,h=t.Matrix4.inverseTransformation(s,new t.Matrix4),f=i.Cartesian3.negate(p,_),t.Matrix4.multiply(t.Matrix4.fromTranslation(f,w),h,h),(f=_).x=1/a.x,f.y=1/a.y,f.z=1/a.z,t.Matrix4.multiply(t.Matrix4.fromScale(f,w),h,h),f=t.Matrix4.clone(s),t.Matrix4.setTranslation(f,i.Cartesian3.ZERO,f),s=t.Matrix4.clone(s,new t.Matrix4),p=t.Matrix4.fromTranslation(p,w),a=t.Matrix4.fromScale(a,A),a=t.Matrix4.multiply(p,a,w),t.Matrix4.multiply(s,a,s),t.Matrix4.multiply(f,a,f)),this.quantization=x,this.minimumHeight=o,this.maximumHeight=n,this.center=i.Cartesian3.clone(e),this.toScaledENU=h,this.fromScaledENU=s,this.matrix=f,this.hasVertexNormals=c,this.hasWebMercatorT=r.defaultValue(d,!1),this.hasGeodeticSurfaceNormals=r.defaultValue(u,!1),this.exaggeration=r.defaultValue(m,1),this.exaggerationRelativeHeight=r.defaultValue(l,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}q.prototype.encode=function(e,a,r,n,c,d,u,m){var l,h,f=n.x,p=n.y;return this.quantization===z.BITS12?((r=t.Matrix4.multiplyByPoint(this.toScaledENU,r,_)).x=s.CesiumMath.clamp(r.x,0,1),r.y=s.CesiumMath.clamp(r.y,0,1),r.z=s.CesiumMath.clamp(r.z,0,1),l=this.maximumHeight-this.minimumHeight,h=s.CesiumMath.clamp((c-this.minimumHeight)/l,0,1),i.Cartesian2.fromElements(r.x,r.y,H),n=o.AttributeCompression.compressTextureCoordinates(H),i.Cartesian2.fromElements(r.z,h,H),l=o.AttributeCompression.compressTextureCoordinates(H),i.Cartesian2.fromElements(f,p,H),h=o.AttributeCompression.compressTextureCoordinates(H),e[a++]=n,e[a++]=l,e[a++]=h,this.hasWebMercatorT&&(i.Cartesian2.fromElements(u,0,H),h=o.AttributeCompression.compressTextureCoordinates(H),e[a++]=h)):(i.Cartesian3.subtract(r,this.center,_),e[a++]=_.x,e[a++]=_.y,e[a++]=_.z,e[a++]=c,e[a++]=f,e[a++]=p,this.hasWebMercatorT&&(e[a++]=u)),this.hasVertexNormals&&(e[a++]=o.AttributeCompression.octPackFloat(d)),this.hasGeodeticSurfaceNormals&&(e[a++]=m.x,e[a++]=m.y,e[a++]=m.z),a};var V=new i.Cartesian3,G=new i.Cartesian3;q.prototype.addGeodeticSurfaceNormals=function(e,t,i){if(!this.hasGeodeticSurfaceNormals){var a=this.stride,r=e.length/a;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();for(var o=this.stride,n=0;n<r;n++){for(var s=0;s<a;s++)t[n*o+s]=e[n*a+s];var c=this.decodePosition(t,n,V),d=i.geodeticSurfaceNormal(c,G);t[c=n*o+this._offsetGeodeticSurfaceNormal]=d.x,t[c+1]=d.y,t[c+2]=d.z}}},q.prototype.removeGeodeticSurfaceNormals=function(e,t){if(this.hasGeodeticSurfaceNormals){var i=this.stride,a=e.length/i;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();for(var r=this.stride,o=0;o<a;o++)for(var n=0;n<r;n++)t[o*r+n]=e[o*i+n]}},q.prototype.decodePosition=function(e,a,n){if(r.defined(n)||(n=new i.Cartesian3),a*=this.stride,this.quantization!==z.BITS12)return n.x=e[a],n.y=e[a+1],n.z=e[a+2],i.Cartesian3.add(n,this.center,n);var s=o.AttributeCompression.decompressTextureCoordinates(e[a],H);return n.x=s.x,n.y=s.y,a=o.AttributeCompression.decompressTextureCoordinates(e[a+1],H),n.z=a.x,t.Matrix4.multiplyByPoint(this.fromScaledENU,n,n)},q.prototype.getExaggeratedPosition=function(e,t,i){i=this.decodePosition(e,t,i);var a,r=this.exaggeration,o=this.exaggerationRelativeHeight;return 1!==r&&this.hasGeodeticSurfaceNormals&&(a=this.decodeGeodeticSurfaceNormal(e,t,G),t=this.decodeHeight(e,t),t=P.getHeight(t,r,o)-t,i.x+=a.x*t,i.y+=a.y*t,i.z+=a.z*t),i},q.prototype.decodeTextureCoordinates=function(e,t,a){return r.defined(a)||(a=new i.Cartesian2),t*=this.stride,this.quantization===z.BITS12?o.AttributeCompression.decompressTextureCoordinates(e[t+2],a):i.Cartesian2.fromElements(e[t+4],e[t+5],a)},q.prototype.decodeHeight=function(e,t){return t*=this.stride,this.quantization!==z.BITS12?e[t+3]:o.AttributeCompression.decompressTextureCoordinates(e[t+1],H).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight},q.prototype.decodeWebMercatorT=function(e,t){return t*=this.stride,this.quantization===z.BITS12?o.AttributeCompression.decompressTextureCoordinates(e[t+3],H).x:e[t+6]},q.prototype.getOctEncodedNormal=function(e,t,a){return e=e[t=t*this.stride+this._offsetVertexNormal]/256,t=Math.floor(e),i.Cartesian2.fromElements(t,256*(e-t),a)},q.prototype.decodeGeodeticSurfaceNormal=function(e,t,i){return t=t*this.stride+this._offsetGeodeticSurfaceNormal,i.x=e[t],i.y=e[t+1],i.z=e[t+2],i},q.prototype._calculateStrideAndOffsets=function(){var e=0;this.quantization===z.BITS12?e+=3:e+=6,this.hasWebMercatorT&&(e+=1),this.hasVertexNormals&&(this._offsetVertexNormal=e,e+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=e,e+=3),this.stride=e};var O={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},B={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};q.prototype.getAttributes=function(e){var t,i,a=n.ComponentDatatype.FLOAT,r=n.ComponentDatatype.getSizeInBytes(a),o=this.stride*r,s=0,c=[];function d(t,i){c.push({index:t,vertexBuffer:e,componentDatatype:a,componentsPerAttribute:i,offsetInBytes:s,strideInBytes:o}),s+=i*r}return this.quantization===z.NONE?(d(O.position3DAndHeight,4),i=2,i+=this.hasWebMercatorT?1:0,i+=this.hasVertexNormals?1:0,d(O.textureCoordAndEncodedNormals,i),this.hasGeodeticSurfaceNormals&&d(O.geodeticSurfaceNormal,3)):(t=this.hasWebMercatorT||this.hasVertexNormals,i=this.hasWebMercatorT&&this.hasVertexNormals,d(B.compressed0,t?4:3),i&&d(B.compressed1,1),this.hasGeodeticSurfaceNormals&&d(B.geodeticSurfaceNormal,3)),c},q.prototype.getAttributeLocations=function(){return this.quantization===z.NONE?O:B},q.clone=function(e,a){if(r.defined(e))return(a=r.defined(a)?a:new q).quantization=e.quantization,a.minimumHeight=e.minimumHeight,a.maximumHeight=e.maximumHeight,a.center=i.Cartesian3.clone(e.center),a.toScaledENU=t.Matrix4.clone(e.toScaledENU),a.fromScaledENU=t.Matrix4.clone(e.fromScaledENU),a.matrix=t.Matrix4.clone(e.matrix),a.hasVertexNormals=e.hasVertexNormals,a.hasWebMercatorT=e.hasWebMercatorT,a.hasGeodeticSurfaceNormals=e.hasGeodeticSurfaceNormals,a.exaggeration=e.exaggeration,a.exaggerationRelativeHeight=e.exaggerationRelativeHeight,a._calculateStrideAndOffsets(),a},e.EllipsoidalOccluder=c,e.TerrainEncoding=q}));